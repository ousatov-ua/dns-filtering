-- dnsdist configuration file, an example can be found in /usr/share/doc/dnsdist/examples/

-- disable security status polling via DNS
setSecurityPollSuffix("")

-- allow query from all IP addresses
addACL('0.0.0.0/0')

addLocal('0.0.0.0:53', { reusePort=true, tcpFastOpenQueueSize=64})
addLocal('0.0.0.0:53', { reusePort=true, tcpFastOpenQueueSize=64})
addLocal('0.0.0.0:53', { reusePort=true, tcpFastOpenQueueSize=64})
addLocal('0.0.0.0:53', { reusePort=true, tcpFastOpenQueueSize=64})
-- add a DoH resolver listening on port 443 of all interfaces
addDOHLocal("0.0.0.0:443", "/opt/lego/dnsdist/olus-dns.com.crt", "/opt/lego/dnsdist/olus-dns.com.key", { 
 "/dns-query/<clientId>"
 }, {reusePort=true, customResponseHeaders={["alt-svc"]="h3=\":443\""}, tcpFastOpenQueueSize=64})

-- add a DoH resolver listening on port 443 of all interfaces
addDOHLocal("0.0.0.0:443", "/opt/lego/dnsdist/olus-dns.com.crt", "/opt/lego/dnsdist/olus-dns.com.key", { 
 "/dns-query/<clientId>"
 }, {reusePort=true, customResponseHeaders={["alt-svc"]="h3=\":443\""}, tcpFastOpenQueueSize=64})

-- add a DoH resolver listening on port 443 of all interfaces
addDOHLocal("0.0.0.0:443", "/opt/lego/dnsdist/olus-dns.com.crt", "/opt/lego/dnsdist/olus-dns.com.key", { 
 "/dns-query/<clientId>"
 }, {reusePort=true, customResponseHeaders={["alt-svc"]="h3=\":443\""}, tcpFastOpenQueueSize=64})

-- add a DoH resolver listening on port 443 of all interfaces
addDOHLocal("0.0.0.0:443", "/opt/lego/dnsdist/olus-dns.com.crt", "/opt/lego/dnsdist/olus-dns.com.key", { 
 "/dns-query/<clientId>"
 }, {reusePort=true, customResponseHeaders={["alt-svc"]="h3=\":443\""}, tcpFastOpenQueueSize=64})


addDOH3Local("0.0.0.0", "/opt/lego/dnsdist/olus-dns.com.crt", "/opt/lego/dnsdist/olus-dns.com.key", 
{reusePort=true, tcpFastOpenQueueSize=64, congestionControlAlgo="bbr"})
addDOH3Local("0.0.0.0", "/opt/lego/dnsdist/olus-dns.com.crt", "/opt/lego/dnsdist/olus-dns.com.key", 
{reusePort=true, tcpFastOpenQueueSize=64, congestionControlAlgo="bbr"})
addDOH3Local("0.0.0.0", "/opt/lego/dnsdist/olus-dns.com.crt", "/opt/lego/dnsdist/olus-dns.com.key", 
{reusePort=true, tcpFastOpenQueueSize=64, congestionControlAlgo="bbr"})
addDOH3Local("0.0.0.0", "/opt/lego/dnsdist/olus-dns.com.crt", "/opt/lego/dnsdist/olus-dns.com.key", 
{reusePort=true, tcpFastOpenQueueSize=64, congestionControlAlgo="bbr"})

-- downstream resolver
newServer({address="127.0.0.1:5353", name="local1", tcpFastOpenQueueSize=64})
newServer({address="127.0.0.1:5353", name="local2", tcpFastOpenQueueSize=64})
newServer({address="127.0.0.1:5353", name="local3", tcpFastOpenQueueSize=64})
newServer({address="127.0.0.1:5353", name="local4", tcpFastOpenQueueSize=64})
